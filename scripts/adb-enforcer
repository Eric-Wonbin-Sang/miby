#!/bin/sh

LOG="/usr/data/adb_boot.log"
TMPLOG="/tmp/adb_boot.log"
SDLOG="/mnt/sd0/adb_boot.log"

log() {
  echo "[S90adb] $*" >> "$TMPLOG"
  # Mirror to kernel log so we can see it via dmesg/serial
  echo "[S90adb] $*" > /dev/kmsg 2>/dev/null || true
}

bind_udc() {
  # Bind the gadget to the first available UDC
  UDC_NAME=$(ls /sys/class/udc/ 2>/dev/null | head -n1)
  if [ -n "$UDC_NAME" ] && [ -e /sys/kernel/config/usb_gadget/adb_demo/UDC ]; then
    echo "$UDC_NAME" > /sys/kernel/config/usb_gadget/adb_demo/UDC 2>>"$TMPLOG" || true
    log "UDC bind attempted: $UDC_NAME"
    sleep 1
    if [ -s /sys/kernel/config/usb_gadget/adb_demo/UDC ]; then
      log "UDC bound: $(cat /sys/kernel/config/usb_gadget/adb_demo/UDC 2>/dev/null)"
    else
      log "UDC binding not confirmed"
    fi
  else
    log "UDC path or name not available"
  fi
}

case "$1" in
  start)
    : > "$TMPLOG" 2>/dev/null || true
    log "=== S90adb start ==="
    date >> "$TMPLOG" 2>/dev/null || true

    # Enable ADB using vendor helper (stops mass storage, sets up gadget, starts adbd)
    /usr/bin/adbon >>"$TMPLOG" 2>&1 || true

    # Wait briefly for configfs gadget path to appear, then bind UDC
    for i in 1 2 3 4 5; do
      if [ -e /sys/kernel/config/usb_gadget/adb_demo/UDC ]; then
        log "adb_demo gadget present"
        break
      fi
      sleep 0.5
    done

    # Use vendor helper if present, otherwise bind directly
    if [ -e /sys/kernel/config/usb_gadget/adb_demo/UDC ]; then
      if [ -x /sbin/usb_adb_enable.sh ]; then
        /sbin/usb_adb_enable.sh >>"$TMPLOG" 2>&1 || true
        log "usb_adb_enable.sh invoked"
      fi
      bind_udc
    else
      log "adb_demo gadget path missing; skipping UDC bind"
    fi

    # Verify adbd is running
    if pidof adbd >/dev/null 2>&1; then
      log "adbd running (pid $(pidof adbd))"
    else
      log "adbd not running"
    fi

    # Try to persist log to /usr/data if available
    if [ -d /usr/data ] && touch "$LOG" 2>/dev/null; then
      cat "$TMPLOG" >> "$LOG" 2>/dev/null || true
      log "Log persisted to $LOG"
    fi

    # Also attempt to copy to SD card once it mounts (background retry)
    (
      for i in 1 2 3 4 5 6 7 8 9 10; do
        if mount | grep -q " /mnt/sd0 "; then
          cp "$TMPLOG" "$SDLOG" 2>/dev/null && log "Copied log to $SDLOG" && break
        fi
        sleep 1
      done
    ) &
    ;;
  stop)
    echo "=== S90adb stop ===" >> "$TMPLOG" 2>/dev/null || true
    [ -x /usr/bin/adboff ] && /usr/bin/adboff >>"$TMPLOG" 2>&1 || true
    ;;
esac

exit 0

